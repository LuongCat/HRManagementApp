<UserControl x:Class="HRManagementApp.UI.Views.DepartmentPayrollView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:HRManagementApp.UI.Views.Converters"
             xmlns:constants="clr-namespace:HRManagementApp.Constants;assembly=HRManagementApp.Models"
             xmlns:converters1="clr-namespace:HRManagementApp.Converters;assembly=HRManagementApp.Models"
             Background="#F5F7FA">

    <UserControl.Resources>
        <converters:GroupTotalSalaryConverter x:Key="GroupTotalSalaryConverter"/>
        <converters1:PermissionToBooleanConverter x:Key="PermToBool"/>
        <CollectionViewSource x:Key="cvsPayroll" Source="{Binding}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="TenPhongBan"/>
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>

        <Style x:Key="GroupHeaderStyle" TargetType="{x:Type GroupItem}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type GroupItem}">
                        <StackPanel>
                            <Border Background="#E0E7FF" BorderBrush="#C7D2FE" BorderThickness="1" 
                                    CornerRadius="4" Margin="0,10,0,0" Padding="15,8">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <TextBlock Text="ðŸ¢" Margin="0,0,5,0"/>
                                        <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="#3730A3" FontSize="14"/>
                                        <TextBlock Text=" - SL: " Foreground="#6B7280" Margin="10,0,0,0"/>
                                        <TextBlock Text="{Binding ItemCount}" FontWeight="SemiBold" Foreground="#374151"/>
                                    </StackPanel>

                                    <TextBlock Grid.Column="2" 
                                               Text="{Binding Items, Converter={StaticResource GroupTotalSalaryConverter}}" 
                                               FontWeight="Bold" Foreground="#DC2626" FontSize="14"/>
                                </Grid>
                            </Border>
                            <ItemsPresenter />
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid Margin="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" CornerRadius="8" Padding="15" Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Báº£ng lÆ°Æ¡ng theo PhÃ²ng Ban" FontSize="20" FontWeight="Bold" Foreground="#1F2937"/>
                    
                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                        <TextBlock Text="Lá»c phÃ²ng ban:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <ComboBox x:Name="cboPhongBan" Width="200" Height="30" 
                                  DisplayMemberPath="TenPB" SelectedValuePath="MaPB"
                                  VerticalContentAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Bottom">
                    <TextBlock Text="ThÃ¡ng:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBox x:Name="txtMonth" Width="40" Height="30" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                    
                    <TextBlock Text="/" VerticalAlignment="Center" Margin="5,0"/>
                    <TextBox x:Name="txtYear" Width="60" Height="30" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>

                    <Button Content="TÃ­nh &amp; Xem LÆ°Æ¡ng" Click="LoadData_Click"
                            Background="#2563EB" Foreground="White" FontWeight="SemiBold"
                            Padding="15,0" Margin="15,0,0,0" Height="35" BorderThickness="0"
                            IsEnabled="{Binding Converter={StaticResource PermToBool}, ConverterParameter={x:Static constants:AppPermissions.LUONG_TINHTOAN}}">
                        <Button.Resources>
                            <Style TargetType="Border"><Setter Property="CornerRadius" Value="4"/></Style>
                        </Button.Resources>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <DataGrid x:Name="dgPayroll" Grid.Row="1"
                  AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                  HeadersVisibility="Column" GridLinesVisibility="Horizontal"
                  RowHeight="40" Background="White" BorderThickness="0">
            
            <DataGrid.GroupStyle>
                <GroupStyle ContainerStyle="{StaticResource GroupHeaderStyle}">
                    <GroupStyle.Panel>
                        <ItemsPanelTemplate>
                            <DataGridRowsPresenter/>
                        </ItemsPanelTemplate>
                    </GroupStyle.Panel>
                </GroupStyle>
            </DataGrid.GroupStyle>

            <DataGrid.Columns>
                <DataGridTextColumn Header="MÃ£ NV" Binding="{Binding MaNV}" Width="70"/>
                <DataGridTextColumn Header="Há» tÃªn" Binding="{Binding TenNV}" Width="180" FontWeight="SemiBold"/>
                <DataGridTextColumn Header="LÆ°Æ¡ng CB" Binding="{Binding LuongCoBan, StringFormat=N0}" Width="100"/>
                <DataGridTextColumn Header="NgÃ y cÃ´ng" Binding="{Binding TongNgayCong}" Width="80"/>
                <DataGridTextColumn Header="Thá»±c nháº­n" Binding="{Binding LuongThucNhan, StringFormat=N0}" Width="*" FontWeight="Bold" Foreground="#2563EB"/>
                <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding TrangThai}" Width="120"/>
            </DataGrid.Columns>
        </DataGrid>
        
        <Border Grid.Row="2" Background="#FFFBEB" Margin="0,10,0,0" Padding="15" CornerRadius="8" BorderBrush="#FCD34D" BorderThickness="1">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <TextBlock Text="Tá»•ng quá»¹ lÆ°Æ¡ng toÃ n bá»™:" FontSize="14" FontWeight="SemiBold" Foreground="#92400E"/>
                <TextBlock x:Name="txtTotalSalary" Text="0 VNÄ" FontSize="16" FontWeight="Bold" Foreground="#B45309" Margin="10,0,0,0"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>